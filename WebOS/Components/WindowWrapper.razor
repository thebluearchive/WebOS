@inject IJSRuntime JS
@inject IWindowManager windowManager

<div class="program-container"
     style="width:@Window.Width; height:@Window.Height; 
        top: @String.Concat(Window.YPos, "px"); left: @String.Concat(Window.XPos, "px");
        z-index:@Window.ZIndex; cursor:@cursorStyle;"
     hidden=@(!Window.Visible)
     @onmousedown=WindowFocused
     @onmousemove=MouseMoved
     @ref=programContainer>
    <div class="title-bar skin"
         @onmousedown="StartDrag">
         <div class="title">
            @Window.Name
         </div>
         <div class="title-bar-button-container">
            <btn class="button title-bar-button"
                 @onclick="Window.Close">
                x
             </btn>
            <btn class="button title-bar-button"
                 @onclick="Window.Maximize">
                []
             </btn>
            <btn class="button title-bar-button"
                 @onclick="Window.Minimize">
                --
            </btn>
         </div>
    </div>
    <div class="program-body skin">
        @Window.ChildContent
    </div>
</div>

@code {
    [Parameter]
    public Window Window { get; set; }
    [Parameter]
    public EventCallback<Window> OnWindowClosed { get; set; }
    [Parameter]
    public EventCallback<Window> OnWindowFocused { get; set; }

    private ElementReference programContainer;
    private DotNetObjectReference<WindowWrapper>? dotNetHelper;
    private IJSObjectReference? jsModule;
    /// <summary>
    /// Window drag variables
    /// </summary>
    private double StartX, StartY;
    private static int MARGIN = 4;
    private string cursorStyle = "auto";

    protected override async Task OnInitializedAsync()
    {
        dotNetHelper = DotNetObjectReference.Create(this);
        jsModule = await JS.InvokeAsync<IJSObjectReference>("import", "./Components/WindowWrapper.razor.js");
        Window.OnWindowStateChanged += (obj, args) => StateHasChanged();
    }

    private async Task StartDrag(MouseEventArgs args)
    {
        // Cannot drag a maximized window
        if (Window.windowState == WindowState.Maximized)
        {
            return;
        }
        StartX = args.ClientX;
        StartY = args.ClientY;
        await jsModule.InvokeVoidAsync("dragStart", dotNetHelper);
    }

    [JSInvokable]
    public void MouseMove(double clientX, double clientY)
    {
        double offsetX = clientX - StartX;
        double offsetY = clientY - StartY;
        Window.XPos += offsetX;
        Window.YPos += offsetY;
        StartX = clientX;
        StartY = clientY;
        StateHasChanged();
    }

    private async Task WindowFocused(MouseEventArgs args)
    {
        await OnWindowFocused.InvokeAsync(Window);
    }

    private async Task MouseMoved(MouseEventArgs args)
    {
        double pixelWidth = await jsModule.InvokeAsync<double>("getElementWidth", programContainer);
        double pixelHeight = await jsModule.InvokeAsync<double>("getElementHeight", programContainer);
        bool onLeftBorder = Math.Abs(args.ClientX - Window.XPos) < MARGIN;
        bool onRightBorder = Math.Abs(args.ClientX - Window.XPos - pixelWidth) < MARGIN;
        bool onTopBorder = Math.Abs(args.ClientY - Window.YPos) < MARGIN;
        bool onBottomBorder = Math.Abs(args.ClientY - Window.YPos - pixelHeight) < MARGIN;
        bool onTopLeftCorner = onTopBorder && onLeftBorder;
        bool onTopRightCorner = onTopBorder && onRightBorder;
        bool onBottomLeftCorner = onBottomBorder && onLeftBorder;
        bool onBottomRightCorner = onBottomBorder && onRightBorder;

        if (onTopLeftCorner || onBottomRightCorner)
        {
            cursorStyle = "nwse-resize";
        }
        else if (onTopRightCorner || onBottomLeftCorner)
        {
            cursorStyle = "nesw-resize";
        }
        else if (onLeftBorder || onRightBorder)
        {
            cursorStyle = "ew-resize";
        }
        else if (onTopBorder || onBottomBorder)
        {
            cursorStyle = "ns-resize";
        }
        else
        {
            cursorStyle = "auto";
        }
    }
}
